---
title: "HW1_implementation"
output:
  pdf_document: default
  html_document: default
date: "2025-01-25"
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(tidyr)
library(knitr)
library(dplyr)

#source(here("source", "utils.R"))
#source(here("simulations", "run_sim_wald.R"))

set.seed(50)
```

### 1.1: ADEMP Structure 

Answer the following questions: 

* How many simulation scenarios will you be running?
We will be running 3 * 3 * 2   = 18 simulation scenarios

* What are the estimand(s)
The estimands are the average treatment effect $\beta_{treatment}$ and the 
standard error of treatment effect $se(\beta_{treatment})$

* What method(s) are being evaluated/compared?

3 methods are being compared - Wald confidence intervals, nonparametric 
bootstrap percentile intervals, and nonparametric boostrap t-intervals.

* What are the performance measure(s)?
The performance measures are bias, coverage, and computation time.

# 1.2: nSim
Based on desired coverage of 95\% with Monte Carlo error of no more than 1\%, how many simulations ($n_{sim}$) should we perform for each simulation scenario?  Implement this number of simulations throughout your simulation study.


```{r}
mc_err <- 0.01
cover <- 0.95
alpha <- 1 - 0.95
n_sim <- (cover * (1 - cover))/mc_err^2
n_sim
num_scenarios <- 18


```






# 1.4 summary table

bias: once per scenario (so 18 biases)
variance: once per scenario (so 18 var hat beta hats) - can do for wald i think? as beta hats r not means like boot
coverage: average per scenario (so 18 coverage percentages)
computation time: average per scenario (so 18 computation time rows, 3 cols for wald/boot p/boot t)

bootstrap se_hat_beta_hat = once after all bootstrap runs (i.e. nboot 50) so 475 rows ??? - think i have this already

can plot histogram of SEs for bootstrap? (facet by error type and sample size n )


```{r}
all_wald_results <- vector("list", num_scenarios)
all_boot_p_results <- vector("list", num_scenarios)
all_boot_t_results <- vector("list", num_scenarios)



# Loop through each scenario file
for (i in 1:num_scenarios) {
  file_path <- here("results", "sim_wald", paste0("scenario_", i, ".RDA"))
  load(file_path)
  
  all_wald_results[[i]] <- all_wald_estim
  
  file_path <- here("results", "sim_boot_percentile", paste0("scenario_", i, ".RDA"))
  load(file_path)
  
  all_boot_p_results[[i]] <- all_boot_percent_estim
  
  file_path <- here("results", "sim_boot_t", paste0("scenario_", i, ".RDA"))
  load(file_path)
  
  all_boot_t_results[[i]] <- all_boot_t_estim

}


```


```{r}
all_biases <- rep(NA, num_scenarios)
var_hat <- rep(NA, num_scenarios)
wald_coverage <- rep(NA, num_scenarios)
boot_p_coverage <- rep(NA, num_scenarios)
boot_t_coverage <- rep(NA, num_scenarios)
wald_time <- rep(NA, num_scenarios)
boot_p_time <- rep(NA, num_scenarios)
boot_t_time <- rep(NA, num_scenarios)
all_n <- rep(NA, num_scenarios)
all_beta_true <- rep(NA, num_scenarios)
all_err_type <- rep(NA, num_scenarios)
scenario_num <- rep(NA, num_scenarios)
mean_wald_se_beta <- rep(NA, num_scenarios)
mean_boot_p_se_beta <- rep(NA, num_scenarios)
mean_boot_t_se_beta <- rep(NA, num_scenarios)
se_hat <- rep(NA, num_scenarios)
se_hat_se <- rep(NA, num_scenarios)
  
for (i in 1:num_scenarios) {
  
  all_biases[i] <- (1/n_sim) * sum(all_wald_results[[i]]$beta_hat - all_wald_results[[i]]$beta_true)
  var_hat[i] <- sd(all_wald_results[[i]]$beta_hat)
  se_hat[i] <- mean(all_wald_results[[i]]$se_beta)
  se_hat_se[i] <- sd(all_wald_results[[i]]$se_beta)
  wald_coverage[i] <- mean(all_wald_results[[i]]$coverage == 1) * 100
  boot_p_coverage[i] <- mean(all_boot_p_results[[i]]$coverage == 1) * 100
  boot_t_coverage[i] <- mean(all_boot_t_results[[i]]$coverage == 1) * 100
  wald_time[i] <- mean(all_wald_results[[i]]$time)
  boot_p_time[i] <- mean(all_boot_p_results[[i]]$time)
  boot_t_time[i] <- mean(all_boot_t_results[[i]]$time)
  all_n[i] <- unique(all_wald_results[[i]]$n)[[1]]
  all_beta_true[i] <- unique(all_wald_results[[i]]$beta_true)
  all_err_type[i] <- unique(all_wald_results[[i]]$err_type)
  mean_wald_se_beta[i] <- mean(all_wald_results[[i]]$se_beta)
  mean_boot_p_se_beta[i] <- mean(all_boot_p_results[[i]]$se_beta)
  mean_boot_t_se_beta[i] <- mean(all_boot_t_results[[i]]$se_beta)

  
  scenario_num[i] <- i
}

df <- bind_cols(
  scenario_num = scenario_num, 
  n = all_n, 
  beta_true = all_beta_true, 
  error_type = all_err_type, 
  bias = all_biases,
  var = var_hat,
  se_hat = se_hat,
  se_hat_se = se_hat_se,
  wald_coverage = wald_coverage,
  wald_time = wald_time,
  wald_se = mean_wald_se_beta,
  boot_p_coverage = boot_p_coverage,
  boot_p_time = boot_p_time,
  boot_p_se = mean_boot_p_se_beta,
  boot_t_coverage = boot_t_coverage,
  boot_t_time = boot_t_time,
  boot_t_se = mean_boot_t_se_beta
  )


df <- df %>%
  mutate(
    error_type = case_when(
      error_type == 0 ~ "Lognormal",
      error_type == 1 ~ "Normal",
      TRUE ~ as.character(error_type) 
    )
  )


```



```{r}
bias_table <- df %>%
  select(n, beta_true, error_type, bias) %>%  
  pivot_wider(
    names_from = error_type,
    values_from = bias,   
  ) %>%
  arrange(n, beta_true)

kable(bias_table, digits = 3, caption = "Bias Summary Table")
```

```{r}
coverage_table <- df %>%
  select(n, beta_true, error_type, wald_coverage, boot_p_coverage, boot_t_coverage) %>%
  arrange(n, beta_true, error_type) %>%
  pivot_longer(
    cols = c(wald_coverage, boot_p_coverage, boot_t_coverage),
    names_to = "Method",
    names_pattern = "(.*)_coverage", 
    values_to = "Coverage"
  ) %>%
  pivot_wider(
    names_from = Method, 
    values_from = Coverage
  )

kable(coverage_table, digits = 3, caption = "Coverage Summary Table")

```
```{r}
time_table <- df %>%
  select(n, beta_true, error_type, wald_time, boot_p_time, boot_t_time) %>%
  arrange(n, beta_true, error_type) %>%
  pivot_longer(
    cols = c(wald_time, boot_p_time, boot_t_time),
    names_to = "Method",
    names_pattern = "(.*)_time",
    values_to = "Time"
  ) %>%
  pivot_wider(
    names_from = Method, 
    values_from = Time
  )

kable(time_table, digits = 3, caption = "CI Time Summary Table")

```





power?